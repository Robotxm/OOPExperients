# 题目三：可变参数表

## 题目原文

Write an `error` function that takes a `printf`-style format string containing `%s`, `%c`, and `%d` directives and an arbitrary number of arguments. Don’t use `printf()`. Look at §21.8 if you don’t know the meaning of `%s`, `%c`, and `%d`. Use `<cstdarg>`.

## 题目翻译

编写函数 `error`，它接受一个类似于 `printf`，包含 `%s`、`%c` 和`%d` 指令的格式字符串和任意数量的参数。不要使用 `printf()`。如果不清楚 `%s`、`%c` 和`%d`，请参考 §21.8 节。请使用 `<cstdarg>` 头文件。

## 题目解析

简单来说这道题就是要求我们自己实现一个类似 `printf` 的函数。可变参数表的使用在教材 7.6 节已经讲过，这里只简单说一下，`va_list` 是参数表的类型（一个字符指针）；`va_start` 用于初始化参数表指针；`va_arg(parg, T)` 是将参数表 `parg` 中的下一个参数以类型 `T` 获取；`va_end` 用户关闭指针。注意后三个实际上是宏而非函数。

我的实现相比题目要求增加了一些额外的内容以接近 `printf`，后面的讲解以我的实现为主。

首先我们扫描字符串，如果这时遇到的字符不是 `%` 则直接原样输出，是的话则开始分析过程。为了支持前导字符（即为输出内容指定最小宽度，输出内容宽度大于等于这个最小宽度时原样输出，不足时用前导字符补齐），我们先看当前字符是不是 0，如果是的话认为前导字符为 0，否则为空格。然后读取最小宽度，这个实现比较简单，遇到数字就累计就好。

接下来开始分析格式字符串。为了统一不同格式的字符串的输出，我单独设置了 `PrintNumber` 函数，可以处理不同进制和格式的数字（`%d`、`%o`、`%x`、`%u`）。对于 `%c` 和 `%s` 的处理可以直接看代码。对于 `%f`，我只支持了以保留小数点后 6 为格式的输出，这里对于小数点位数的设置采用的是 `setprecision`，具体用法请自行查阅资料。对于 `%%` 视为转移百分号，输出一个百分号即可。